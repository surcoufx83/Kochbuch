# Changes in Database

## Recipe localisation

```sql
ALTER TABLE `recipes`
	ADD COLUMN `localized` TINYINT(3) UNSIGNED NOT NULL DEFAULT '0' AFTER `aigenerated`,
	ADD COLUMN `recipe_name_de` VARCHAR(256) NULL DEFAULT NULL AFTER `recipe_name`,
	ADD COLUMN `recipe_name_en` VARCHAR(256) NULL DEFAULT NULL AFTER `recipe_name_de`,
	ADD COLUMN `recipe_description_de` VARCHAR(1024) NULL DEFAULT NULL AFTER `recipe_description`,
	ADD COLUMN `recipe_description_en` VARCHAR(1024) NULL DEFAULT NULL AFTER `recipe_description_de`;

ALTER TABLE `recipe_ingredients`
	ADD COLUMN `ingredient_description_de` VARCHAR(128) NULL DEFAULT NULL AFTER `ingredient_description`,
	ADD COLUMN `ingredient_description_en` VARCHAR(128) NULL DEFAULT NULL AFTER `ingredient_description_de`;

ALTER TABLE `recipe_steps`
	ADD COLUMN `step_title_de` VARCHAR(128) NULL DEFAULT NULL AFTER `step_title`,
	ADD COLUMN `step_title_en` VARCHAR(128) NULL DEFAULT NULL AFTER `step_title_de`,
	ADD COLUMN `step_data_de` TEXT NULL DEFAULT NULL AFTER `step_data`,
	ADD COLUMN `step_data_en` TEXT NULL DEFAULT NULL AFTER `step_data_de`;

ALTER TABLE `units`
	ADD COLUMN `localized` TINYINT UNSIGNED NOT NULL DEFAULT '0' AFTER `useunit_id`,
	ADD COLUMN `unit_name_de` VARCHAR(64) NULL DEFAULT NULL AFTER `unit_name`,
	ADD COLUMN `unit_name_en` VARCHAR(64) NULL DEFAULT NULL AFTER `unit_name_de`;

ALTER ALGORITHM = UNDEFINED DEFINER=`developer`@`192.168.10.%` SQL SECURITY INVOKER VIEW `allrecipes` AS select `r`.`recipe_id` AS `recipe_id`,`r`.`user_id` AS `user_id`,`r`.`edit_user_id` AS `edit_user_id`,`r`.`aigenerated` AS `aigenerated`,`r`.`localized` AS `localized`,`r`.`recipe_placeholder` AS `recipe_placeholder`,`r`.`recipe_public_internal` AS `recipe_public_internal`,`r`.`recipe_public_external` AS `recipe_public_external`,`r`.`recipe_name` AS `recipe_name`,`r`.`recipe_name_de` AS `recipe_name_de`,`r`.`recipe_name_en` AS `recipe_name_en`,`r`.`recipe_description` AS `recipe_description`,`r`.`recipe_description_de` AS `recipe_description_de`,`r`.`recipe_description_en` AS `recipe_description_en`,`r`.`recipe_eater` AS `recipe_eater`,`r`.`recipe_source_desc` AS `recipe_source_desc`,`r`.`recipe_source_url` AS `recipe_source_url`,`r`.`recipe_created` AS `recipe_created`,`r`.`recipe_edited` AS `recipe_edited`,`r`.`recipe_modified` AS `recipe_modified`,`r`.`recipe_published` AS `recipe_published`,`r`.`ingredientsGroupByStep` AS `ingredientsGroupByStep`,`p`.`picture_id` AS `picture_id`,`p`.`picture_sortindex` AS `picture_sortindex`,`p`.`picture_name` AS `picture_name`,`p`.`picture_description` AS `picture_description`,`p`.`picture_hash` AS `picture_hash`,`p`.`picture_filename` AS `picture_filename`,`p`.`picture_full_path` AS `picture_full_path`,`p`.`picture_uploaded` AS `picture_uploaded`,`p`.`picture_width` AS `picture_width`,`p`.`picture_height` AS `picture_height`,`rv`.`views` AS `views`,`rc`.`cooked` AS `cooked`,`v`.`votesum` AS `votesum`,`v`.`votes` AS `votes`,`v`.`avgvotes` AS `avgvotes`,`rr`.`votesum` AS `ratesum`,`rr`.`votes` AS `ratings`,`rr`.`avgvotes` AS `avgratings`,`s`.`stepscount` AS `stepscount`,`s`.`preparationtime` AS `preparationtime`,`s`.`cookingtime` AS `cookingtime`,`s`.`chilltime` AS `chilltime` from ((((((`recipes` `r` left join `recipe_pictures` `p` on(`p`.`recipe_id` = `r`.`recipe_id` and `p`.`picture_sortindex` = 0)) join `voting_cooked` `rc` on(`rc`.`recipe_id` = `r`.`recipe_id`)) join `voting_views` `rv` on(`rv`.`recipe_id` = `r`.`recipe_id`)) join `voting_hearts` `v` on(`v`.`recipe_id` = `r`.`recipe_id`)) join `voting_difficulty` `rr` on(`rr`.`recipe_id` = `r`.`recipe_id`)) join `allrecipessteps` `s` on(`s`.`recipe_id` = `r`.`recipe_id`)) group by `r`.`recipe_id`,`r`.`user_id`,`r`.`edit_user_id`,`r`.`aigenerated`,`r`.`localized`,`r`.`recipe_placeholder`,`r`.`recipe_public_internal`,`r`.`recipe_public_external`,`r`.`recipe_name`,`r`.`recipe_name_de`,`r`.`recipe_name_en`,`r`.`recipe_description`,`r`.`recipe_description_de`,`r`.`recipe_description_en`,`r`.`recipe_eater`,`r`.`recipe_source_desc`,`r`.`recipe_source_url`,`r`.`recipe_created`,`r`.`recipe_edited`,`r`.`recipe_modified`,`r`.`recipe_published`,`r`.`ingredientsGroupByStep`,`p`.`picture_id`,`p`.`picture_sortindex`,`p`.`picture_name`,`p`.`picture_description`,`p`.`picture_hash`,`p`.`picture_filename`,`p`.`picture_full_path`,`p`.`picture_uploaded`,`p`.`picture_width`,`p`.`picture_height`,`rv`.`views`,`rc`.`cooked`,`v`.`votesum`,`v`.`votes`,`v`.`avgvotes`,`s`.`stepscount`,`s`.`preparationtime`,`s`.`cookingtime`,`s`.`chilltime`;

ALTER ALGORITHM = UNDEFINED DEFINER=`developer`@`192.168.10.%` SQL SECURITY INVOKER VIEW `allrecipes_nouser` AS select `allrecipes`.`recipe_id` AS `recipe_id`,`allrecipes`.`user_id` AS `user_id`,`allrecipes`.`edit_user_id` AS `edit_user_id`,`allrecipes`.`aigenerated` AS `aigenerated`,`allrecipes`.`localized` AS `localized`,`allrecipes`.`recipe_placeholder` AS `recipe_placeholder`,`allrecipes`.`recipe_public_internal` AS `recipe_public_internal`,`allrecipes`.`recipe_public_external` AS `recipe_public_external`,`allrecipes`.`recipe_name` AS `recipe_name`,`allrecipes`.`recipe_name_de` AS `recipe_name_de`,`allrecipes`.`recipe_name_en` AS `recipe_name_en`,`allrecipes`.`recipe_description` AS `recipe_description`,`allrecipes`.`recipe_description_de` AS `recipe_description_de`,`allrecipes`.`recipe_description_en` AS `recipe_description_en`,`allrecipes`.`recipe_eater` AS `recipe_eater`,`allrecipes`.`recipe_source_desc` AS `recipe_source_desc`,`allrecipes`.`recipe_source_url` AS `recipe_source_url`,`allrecipes`.`recipe_created` AS `recipe_created`,`allrecipes`.`recipe_edited` AS `recipe_edited`,`allrecipes`.`recipe_modified` AS `recipe_modified`,`allrecipes`.`recipe_published` AS `recipe_published`,`allrecipes`.`ingredientsGroupByStep` AS `ingredientsGroupByStep`,`allrecipes`.`picture_id` AS `picture_id`,`allrecipes`.`picture_sortindex` AS `picture_sortindex`,`allrecipes`.`picture_name` AS `picture_name`,`allrecipes`.`picture_description` AS `picture_description`,`allrecipes`.`picture_hash` AS `picture_hash`,`allrecipes`.`picture_filename` AS `picture_filename`,`allrecipes`.`picture_full_path` AS `picture_full_path`,`allrecipes`.`picture_uploaded` AS `picture_uploaded`,`allrecipes`.`picture_width` AS `picture_width`,`allrecipes`.`picture_height` AS `picture_height`,`allrecipes`.`views` AS `views`,`allrecipes`.`cooked` AS `cooked`,`allrecipes`.`votesum` AS `votesum`,`allrecipes`.`votes` AS `votes`,`allrecipes`.`avgvotes` AS `avgvotes`,`allrecipes`.`ratesum` AS `ratesum`,`allrecipes`.`ratings` AS `ratings`,`allrecipes`.`avgratings` AS `avgratings`,`allrecipes`.`stepscount` AS `stepscount`,`allrecipes`.`preparationtime` AS `preparationtime`,`allrecipes`.`cookingtime` AS `cookingtime`,`allrecipes`.`chilltime` AS `chilltime` from `allrecipes` where `allrecipes`.`recipe_public_external` = 1;

ALTER ALGORITHM = UNDEFINED DEFINER=`developer`@`192.168.10.%` SQL SECURITY INVOKER VIEW `recipe_ingredients_view` AS select `recipe_ingredients`.`recipe_id` AS `recipe_id`,group_concat(distinct `recipe_ingredients`.`ingredient_description` separator '\n') AS `recipe_ingredients`,group_concat(distinct `recipe_ingredients`.`ingredient_description_de` separator '\n') AS `recipe_ingredients_de`,group_concat(distinct `recipe_ingredients`.`ingredient_description_en` separator '\n') AS `recipe_ingredients_en` from `recipe_ingredients` group by `recipe_ingredients`.`recipe_id`;

ALTER ALGORITHM = UNDEFINED DEFINER=`developer`@`192.168.10.%` SQL SECURITY INVOKER VIEW `recipe_steps_view` AS select `recipe_steps`.`recipe_id` AS `recipe_id`,group_concat(distinct `recipe_steps`.`step_data` separator '\n') AS `recipe_steps`,group_concat(distinct `recipe_steps`.`step_data_de` separator '\n') AS `recipe_steps_de`,group_concat(distinct `recipe_steps`.`step_data_en` separator '\n') AS `recipe_steps_en` from `recipe_steps` group by `recipe_steps`.`recipe_id`;

ALTER ALGORITHM = UNDEFINED DEFINER=`developer`@`192.168.10.%` SQL SECURITY INVOKER VIEW `allrecipetextdata` AS select select `r`.`recipe_id` AS `recipe_id`,`r`.`recipe_public_internal` AS `recipe_public_internal`,`r`.`recipe_public_external` AS `recipe_public_external`,`r`.`recipe_name` AS `recipe_name`,`r`.`recipe_name_de` AS `recipe_name_de`,`r`.`recipe_name_en` AS `recipe_name_en`,`r`.`recipe_description` AS `recipe_description`,`r`.`recipe_description_de` AS `recipe_description_de`,`r`.`recipe_description_en` AS `recipe_description_en`,`i`.`recipe_ingredients` AS `recipe_ingredients`,`i`.`recipe_ingredients_de` AS `recipe_ingredients_de`,`i`.`recipe_ingredients_en` AS `recipe_ingredients_en`,`s`.`recipe_steps` AS `recipe_steps`,`s`.`recipe_steps_de` AS `recipe_steps_de`,`s`.`recipe_steps_en` AS `recipe_steps_en`,concat(`r`.`recipe_name`,'\n',`r`.`recipe_description`,'\n',`i`.`recipe_ingredients`,'\n',`s`.`recipe_steps`) AS `recipe_fulltext`,concat(`r`.`recipe_name_de`,'\n',`r`.`recipe_description_de`,'\n',`i`.`recipe_ingredients_de`,'\n',`s`.`recipe_steps_de`) AS `recipe_fulltext_de`,concat(`r`.`recipe_name_en`,'\n',`r`.`recipe_description_en`,'\n',`i`.`recipe_ingredients_en`,'\n',`s`.`recipe_steps_en`) AS `recipe_fulltext_en`,concat(`r`.`recipe_name`,'\n',`r`.`recipe_description`,'\n',`s`.`recipe_steps`) AS `recipe_fulltext_noingredients`,concat(`r`.`recipe_name_de`,'\n',`r`.`recipe_description_de`,'\n',`s`.`recipe_steps_de`) AS `recipe_fulltext_noingredients_de`,concat(`r`.`recipe_name_en`,'\n',`r`.`recipe_description_en`,'\n',`s`.`recipe_steps_en`) AS `recipe_fulltext_noingredients_en` from ((`recipes` `r` join `recipe_ingredients_view` `i` on(`i`.`recipe_id` = `r`.`recipe_id`)) join `recipe_steps_view` `s` on(`s`.`recipe_id` = `r`.`recipe_id`)) where (`r`.`recipe_public_internal` = 1 or `r`.`recipe_public_external` = 1) and `r`.`recipe_placeholder` = 0;


```

## Units usage

```sql
CREATE ALGORITHM = UNDEFINED SQL SECURITY INVOKER VIEW `units_usage` AS SELECT u.unit_id, u.unit_name, COUNT(i.ingredient_id) AS usage_count FROM units u LEFT JOIN recipe_ingredients i ON i.unit_id = u.unit_id GROUP BY u.unit_id, u.unit_name ;
```
